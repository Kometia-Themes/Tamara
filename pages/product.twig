{% extends 'layout.twig' %}
{% block body_class %}category products has-sidebar{% endblock body_class %}
{% block body %}
<br><br class="hidden-xs">
<div class="container">
  <div class="row">
    <div class="wrapper__main-content">
      <article class="product-single">
        <div class="row">
        {% if product.images|length > 0 %}
          <section class="product-media">
            <div id="sp-img-full">
              <figure class="item">
                <img id="zoom" src="{{ product.image_url ~ '&w=750' }}" alt="{{ product.title }} - {{ store.name }}" itemprop="thumbnail">
              </figure>
            </div>
            {% if product.images|length > 1 %}
            <div id="slider-sp-img-thumbs" class="owl-carousel owl-theme fouc">
            {% for image in product.images %}
              <figure class="item">
                <img src="{{ image.url ~ '&w=120&h=120&fit=crop' }}" alt="{{ product.title }} - {{ store.name }}" data-src="{{ image.url ~ '&w=750' }}" itemprop="thumbnail">
              </figure>
            {% endfor %}
            </div>
            {% endif %}
          </section>
        {% else %}
          <section class="product-media">
            <div id="sp-img-full">
              <img class="img-responsive" src="{{ 'placeholders/product-11.jpg' | global_img_url }}" alt="{{ product.title }} - {{ store.name }}" itemprop="thumbnail">
          </section>
        {% endif %}
          <div class="product-info">
            <section class="product-details">
              <h1 class="product-title">{{ product.name }}</h1>
              {% if product.vendor and settings.show_vendor_name %}
              <p class="product-brand">{{ product.vendor.name }}</p>
              {% endif %}
              {% if settings.show_sku_code and product.sku.code is not empty %}
              <p class="product-sku-code js-sku-code"><small>SKU: <strong>{{ product.sku.code }}</strong></small></p>
              {% endif %}
              <div class="product-price">
                <span class="regular-price js-product-price-amount">
                  {{ product.price | money('symbol', 'code') }}
                </span>
                <span class="compared-price js-product-price-compared-amount">  {{ product.sku.compared_price > product.sku.price ? product.sku.compared_price | money('symbol') }}
                </span>
              </div>
              <h5 class="product-summary">{{ product.summary }}</h5>
              <br class="hidden-xs">
              {% if settings.enable_share_products %}
              <div class="product-social-share">
                {% include '_social-share.twig' %}
              </div>
              <hr>
              {% endif %}
              <p class="product-description">{{ product.description|raw }}</p>
            </section>
            <br>
            <section class="product-options">
              <form class="prod_atc" action="/carrito/agregar" method="post">
                <input type="hidden" name="sku_id" value="{{product.sku.id}}">
                <div class="row">
                {% for modifier, options in product.skus_modifiers %}
                  <div class="half">
                    <select name="{{ loop.index0 }}" id="sp-option-{{ loop.index0 }}" class="selectpicker form-control js-variant-select" title="{{ modifier }}">
                    {% for option in options %}
                      <option value="{{ loop.index0 }}">{{ option }}</option>
                    {% endfor %}
                    </select>
                  </div>
                {% endfor %}
                  <div class="half">
                    <select class="selectpicker form-control js-qty-select" title="Cantidad" name="quantity" id="quantity">
                      {% for qty in 1..5 %}
                      <option value="{{ qty }}" {{ qty == item.quantity ? ' selected="selected"' : null }}>{{ qty }}</option>
                      {% endfor %}
                    </select>
                  </div>
                {% if product.is_in_stock %}
                  <div class="full-width fouc">
                    <button class="btn btn-add-to-cart js-atc"><i class="zmdi zmdi-shopping-cart"></i> &nbsp;AÃ±adir a tu carrito</button>
                    <button type="submit" class="btn-add-to-cart js-atc-disabled" disabled="disabled">
                      No disponible
                    </button>
                  </div>
                {% else %}
                  <div class="full-width">
                    <button class="btn-add-to-cart js-atc-disabled" disabled="disabled">
                      No disponible
                    </button>
                  </div>
                {% endif %}
                </div>
              </form>
            </section>
          </div>
        </div>
        <br><br>
        <div class="clearfix"></div>
      </article>
    </div>
    <div class="wrapper__side-content">
      {% include '_sidebar.twig' with { 'show_viewer' : false } %}
    </div>
  </div>
</div>
{% endblock body %}

{% block js_body %}
{{ parent() }}
{% if settings.enable_product_image_zoom %}
{{ '//cdnjs.cloudflare.com/ajax/libs/jquery-zoom/1.7.18/jquery.zoom.min.js' | script_tag }}
{% endif %}

<script type="text/javascript">
{% if settings.enable_product_image_zoom %}

  $( ".product-single #sp-img-full" ).mouseover(function() {
    var baseImage = $('#sp-img-full .item');
    var baseImageUrl = $('#sp-img-full .item img').attr('src');
    baseImage.find('img').attr('src', baseImageUrl);
  });

  function loadZoom() {
    $('#zoom').wrap('<span style="display:inline-block"></span>')
      .css('display', 'block')
      .parent()
      .zoom();
    }
{% endif %}

{% if product.is_in_stock %}
  var skus = {{ product.skus | json }};
  $('.js-atc-disabled').hide();
  showSelectedSku();
  function showSelectedSku() {
    // only one sku, no variants to validate
    if (skus.length == 1) {
      return updateSkuControls(skus[0]);
    }
    // get the product variant modifiers from the selects
    var selectedModifiers = [];
    $('.js-variant-select').each(function() {
      selectedModifiers.push($(this).find(":selected").text());
    });

    var foundSku = null;
    // check if there's an sku with the selected modifiers
    skus.forEach(function(sku) {
      var modifiers = sku.modifiers;
      if ($(modifiers).not(selectedModifiers).length === 0 && $(selectedModifiers).not(modifiers).length === 0) {
        foundSku = sku;
        return false;
      }
    });
    return updateSkuControls(foundSku);
  }
  function updateSkuControls(sku) {
    var enabledAddButton = $('.js-atc');
    var disabledAddButton = $('.js-atc-disabled');
    var comparedPriceElement = $('.js-product-price-compared-amount');

    var imageMain = $('#sp-img-full .item');
    var newImageMain = sku.image_url; // Imag del figure clickeado
    if (newImageMain !== null) {
      imageMain.find('img').attr('src', newImageMain);
    }
    if (sku !== null) {
      if (sku.stock_policy !== 'none' && sku.in_stock < 1) {
        sku = null;
      }
    }
    if (sku !== null) {
      disabledAddButton.hide();
      enabledAddButton.show();
      $('input[name=sku_id]').val(sku.id);
      $('.js-product-price-amount').html(formatPrice(sku.price));
      if (sku.compared_price > sku.price ) {
        comparedPriceElement.html(formatPrice(sku.compared_price)).show();
      } else {
        comparedPriceElement.hide();
      }
    } else {
      disabledAddButton.show();
      enabledAddButton.hide();
      //comparedPriceElement.hide();
    }
    return sku;
  }

  function formatPrice(price) {
    price /= 100;
    price = price.toFixed(2);
    price = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return '$ ' + price + ' {{ store.currency }}';
  }
  $('.js-variant-select').change(function() {
    showSelectedSku();
  });
{% endif %}
$(document).ready(function(){
  {% if settings.enable_product_image_zoom %}
  loadZoom();
  {% endif %}
  var imgCont = $('.product-single #sp-img-full'),
    thumbCont = $('#slider-sp-img-thumbs'),
    owlItem = $('.owl-item');

    thumbCont.owlCarousel({
      margin: 3,
      nav:false,
      responsiveBaseElement: '.wrapper__main-content',
      responsiveClass:true,
      responsive: {
        0: {
            items: 3
        },
        700: {
            items: 4
        }
      }
    }).on('click', '.owl-item .item', function(e) {

      e.preventDefault(); // e es el elemento clickeado
      //** Cambiar imagen grande por la del thumb
      var thumbSrc = $(e.target).attr('data-src'); // Imag del figure clickeado

      imgCont.find('.product-single #sp-img-full figure img').attr('src', thumbSrc); // Sustituir

      //** Poner current al thumb clickeado
      // $(e.target).parents('.owl-item').addClass('current').siblings().removeClass('current');
       // $('html,body').animate({scrollTop: imgCont.offset().top - 50 },250);
       $(this).addClass('current').unbind('click'); // just add this line
      {% if settings.enable_product_image_zoom %}
        imgCont.find('#sp-img-full .item img').attr('src', thumbSrc); // Sustituir
        var zoom = $('#zoom');
        zoom.trigger('zoom.destroy');
        zoom.attr("src", thumbSrc);
        loadZoom();
      {% endif %}
    });

  });
</script>
{% endblock js_body %}
